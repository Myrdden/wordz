<!DOCTYPE html>
<html>
<head>
  <title>Thing</title>
</head>
<body>
<div id='root'></div>

<script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
<script>
const elem = React.createElement;

const Dictionary = props => {
  const populate = data => {
    return data.map((word, index) => {
      if (word.type === 0) {
        return elem(Noun, {...word, key: index}, null);
      } else {
        return elem(Verb, {...word, key: index}, null);
      }
    });
  }

  return elem('div', {className: 'container'},
    populate(props.data)
  );
};

const Noun = props => {
  return elem('div', {className: 'card'},
    elem('h1', {}, props.header)
  );
};

const Verb = props => {
  const [shown, setShown] = React.useState(false);
  const toggleChart = e => {
    e.preventDefault();
    setShown(!shown);
  };

  return elem('div', {className: 'card'},
    elem('h1', {}, props.header),
    elem('p', {}, props.participle),
    elem('p', {}, props.gerunds.reduce((str, ger) => str + ' ' + ger, 'Gerund:')),
    elem('ol', {}, props.definitions.map((def, i) => elem('li', {key: i}, def))),
    elem('button', {onClick: e => toggleChart(e)}, 'clicc'),
    elem(Chart, {shown: shown, data: props.stems}, null)
  );
};

const Chart = props => {
  const isShown = () => {
    return (props.shown ? 'chart' : 'hidden');
  };

  const headers = ['', 'Perfective', 'Imperfective', 'Subjunctive', 'Imperative'];
  const rowHeaders = ['Absolute', 'Conjunct', 'Compound', 'Complex'];

  return elem('div', {className: isShown()},
    elem('table', {},
      elem('tbody', {},
        elem('tr', {}, headers.map((header, i) => elem('th', {key: i}, header))),
        props.data.map((row, i) => {
          return elem('tr', {key: i},
            elem('th', {}, rowHeaders[i]),
            row.map((word, i) => elem('td', {key: i}, word)),
          )
        })
      )
    )
  );
};

const AddVerb = ({addWord}) => {
  const fakeStems = [['','','',''],['','','',''],['','','',''],['','','','']];
  const [input, setInput] = React.useState({listLength: 0, stems: fakeStems});

  const updateInput = e => {
    e.preventDefault();
    let inp = e.target;
    let data = Object.assign({}, input);
    if (inp.name.match(/chart-\d+/g)) {
      let num = inp.name.split('-')[1].padStart(2, '0');
      let i = parseInt(num[0]);
      let j = parseInt(num[1]);
      data.stems[i][j] = inp.value;
    } else {
      if (inp.name.match(/li-\d/g)) {
        let at = parseInt(inp.name.split('-')[1]);
        if (at === input.listLength) {
          data.listLength += 1;
        } else if (at === input.listLength - 1 && inp.value == '') {
          data.listLength -= 1;
        }
      }
      data[inp.name] = inp.value;
    }
    setInput(data);
  };

  const submit = e => {
    e.preventDefault();
    let form = new FormData(e.target);
    let data = {};
    form.forEach((v, k) => data[k] = v);
    let newWord = {};
    if (data.header && data.header !== '') {
      newWord.header = data.header;
      newWord.stems = input.stems;
      addWord(newWord);
    } else {alert('Missing Header');}
  };

  const popDefinitions = length => {
    let ary = new Array(length);
    for(let i = 0; i < length; i++) {
      ary[i] = elem('li', {key: i}, elem('input', {type: 'text', name: 'li-' + i, value: input['li-' + i] || ''}, null));
    }
    ary[length] = elem('li', {key: length}, elem('input', {type: 'text', name: 'li-' + length, value: '', onChange: e => updateInput(e)}, null));
    return ary;
  };

  return elem('form', {className: 'card', onChange: e => updateInput(e), onSubmit: e => submit(e)},
    elem('input', {type: 'text', name: 'header',
      placeholder: 'New Verb', className: 'form-header'}, null),
    elem('input', {type: 'text', name: 'b', placeholder: 'b'}, null),
    elem('h2', {}, 'Definitions:'),
    elem('ol', {},
      popDefinitions(input.listLength)
    ),
    elem(EditChart, {data: input.stems}, null),
    elem('input', {type: 'submit', value: 'go', className: 'form-submit'}, null)
  );
};

const EditChart = ({data}) => {
  const headers = ['', 'Perfective', 'Imperfective', 'Subjunctive', 'Imperative'];
  const rowHeaders = ['Absolute', 'Conjunct', 'Compound', 'Complex'];

  return elem('div', {className: 'chart'},
    elem('table', {},
      elem('tbody', {},
        elem('tr', {}, headers.map((header, i) => elem('th', {key: i}, header))),
        data.map((row, i) => {
          return elem('tr', {key: i},
            elem('th', {}, rowHeaders[i]),
            row.map((word, j) => elem('td', {key: (i*10)+j}, elem('input', {type: 'text',
              className: 'form-chart-input', name: 'chart-' + ((i*10)+j)}, null)))
          )
        })
      )
    )
  );
}

const Input = ({setData}) => {
  const upload = e => {
    e.preventDefault();
    localStorage.clear();
    let reader = new FileReader();
    reader.onload = () => {
      let data = JSON.parse(reader.result);
      data.sort((a,b) => {
        let x = a.header.toUpperCase();
        let y = b.header.toUpperCase();
        return x < y ? -1 : (x > y ? 1 : 0);
      });
      setData(data);
    };
    reader.readAsText(e.target.files[0]);
  };

  return elem('div', {},
    elem('input', {type: 'file', name:'file', onChange: e => upload(e)}, null)
  );
};

const Output = ({data}) => {
  let blob = new Blob([JSON.stringify(data)], {type: 'text/plain;charset=utf-8'});
  return elem('a', {href: URL.createObjectURL(blob), download: 'hecc.txt'}, 'clicc');
}

const App = () => {
  const [data, setData] = React.useState(null);

  React.useEffect(() => {
    localStorage.setItem('data', JSON.stringify(data));
  }, [data]);

  if (data === null) {
    if (localStorage.getItem('data') !== 'null' && localStorage.getItem('data') !== null) {
      setData(JSON.parse(localStorage.getItem('data')));
    }
  }

  const addWord = word => {
    let mutData = [...data];
    let wordComp = word.header.toUpperCase();
    console.log(mutData);
    mutData.push({});
    //let mid = data[data.length >>> 1];
    //if (wordComp > mid.header.toUpperCase()) {
      let i = data.length;
      while (i > 0 && wordComp < mutData[i-1].header.toUpperCase()) {
        mutData[i] = mutData[i-1];
        i -= 1;
      }
      mutData[i] = word;
    //} else {
    //  let i = 0;
    //  while (i < mutData.length && wordComp > mutData[i+1].header.toUpperCase()) {
    //    mutData[i] = mutData[i+1];
    //    i += 1;
    //  }
    //  mutData[i] = word;
    //}
    console.log(mutData);
  };

  //localStorage.clear();
  console.log(data);
  console.log(localStorage.getItem('data'));
  return elem('div', {},
    elem(Input, {setData: setData}, null),
    elem('button', {onClick: () => {setData(null); localStorage.clear();}}, 'Clear'),
    (data !== {} && data !== null) && elem('div', {},
      elem(Output, {data: data}, null),
      elem(AddVerb, {addWord: addWord}, null),
      elem(Dictionary, {data: data}, null)
    )
  );
};

ReactDOM.render(elem(App), document.getElementById('root'));
</script>
<style>
  .hidden {display: none}
  .container {
    display: flex;
    flex-flow: row wrap;
    justify-content: space-evenly;
    align-items: flex-start;
  }
  .card {
    background: dimgrey;
    width: 45%;
    padding: 1rem;
    color: white;
  }
  h1 {

  }
  h2 {
    font-size: 1.2rem;
    margin: 0.5rem 0;
  }
  ol {
    margin: 0.5rem 0;
  }
  .chart {

  }
  td {text-align: center}

  input {
    background: transparent;
    color: white;
    padding: 0.1rem;
    border: 0.1rem solid white;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    box-sizing: border-box;
  }
  input::placeholder {color: white}

  .form-header {
    font-size: 2rem;
    width: 50%;
    display: block;
  }

  .form-chart-input {
    width: 100%;
  }

  .form-submit {
    font-size: 1rem;
    display: block;
  }
</style>
</body>
</html>
